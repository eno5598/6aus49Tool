<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lotto 6aus49 Tool by EnoWeb</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
  :root{ --cy:#00fff0; --mag:#ff00ea; --ink:#eaf7ff; --bg:#060712; --ok:#39ff88; --bad:#ff6b94; }
  body{background:radial-gradient(900px 700px at -10% -10%, rgba(0,255,240,.12), transparent 60%), radial-gradient(900px 700px at 110% -10%, rgba(255,0,234,.12), transparent 60%), var(--bg); color:var(--ink); font-family:Inter, ui-sans-serif, system-ui;}
  .title{background:linear-gradient(90deg,var(--cy),var(--mag)); -webkit-background-clip:text; color:transparent; font-weight:900}
  .glass{background:rgba(15,18,40,.78); backdrop-filter: blur(14px); border:1px solid rgba(0,255,255,.18); border-radius:14px; padding:14px; box-shadow: 0 12px 40px rgba(0,0,0,.45);}
  .nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px; min-width:90px;height:78px;padding:8px 10px;border-radius:16px;background:linear-gradient(180deg,rgba(18,24,50,.9),rgba(14,18,36,.9)); border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.4);}
  .nav-btn.active{outline:2px solid rgba(255,255,255,.15); box-shadow:0 0 20px rgba(0,255,255,.35), inset 0 0 0 1px rgba(255,255,255,.1);}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:32px;border-radius:10px;margin:4px;font-weight:800;font-size:.9rem;color:#bdfcff;background:linear-gradient(180deg,#0e1530,#15204a);border:1px solid rgba(0,255,255,.25);}
  .chip.super{color:#fff3d1;background:linear-gradient(180deg,#2b1f0e,#433516);border-color:rgba(255,217,0,.35)}
  .badge{background:rgba(255,255,255,.06); border:1px solid rgba(140,170,255,.22); border-radius:999px; padding:.2rem .6rem; font-size:.74rem;}
  .counter{padding:.2rem .55rem;border-radius:999px;font-weight:700}
  .counter.red{background:#3a1520;border:1px solid var(--bad)}
  .counter.green{background:#153a29;border:1px solid var(--ok)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;height:44px;padding:0 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:700}
  .btn--green{background:#15803d;color:#fff;}
  .btn--amber{background:#b45309;color:#fff;}
  .btn--gray{background:#374151;color:#fff;}
  .btn:hover{filter:brightness(1.1)}
  .file-label{cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg,rgba(18,24,50,.9),rgba(14,18,36,.9)); display:inline-flex; gap:8px; align-items:center;}
  .file-input{display:none}
</style>
</head>
<body class="p-5">
  <h1 class="title text-3xl md:text-4xl mb-4">Lotto 6aus49 Tool by EnoWeb</h1>

  <div class="flex justify-center flex-wrap gap-3 mb-6">
    <button type="button" onclick="tab('archiv', this)" class="nav-btn active" id="btn-archiv"><div>ğŸ“‚</div><span>Archiv</span></button>
    <button type="button" onclick="tab('gen', this)" class="nav-btn" id="btn-gen"><div>âš¡</div><span>Generieren</span></button>
    <button type="button" onclick="tab('ana', this)" class="nav-btn" id="btn-ana"><div>ğŸ“Š</div><span>Analyse</span></button>
  </div>

  <!-- ARCHIV -->
  <div id="v-archiv" class="glass">
    <h2 class="text-xl font-bold mb-2">ğŸ“‚ Archiv</h2>
    <p id="statusText" class="text-sm mb-2">Noch kein Archiv geladen.</p>

    <div class="glass mb-3">
      <div class="font-semibold mb-2">Automatisches Laden</div>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="archiveUrl" class="bg-gray-900 p-2 rounded flex-1" value="https://www.lotto-bayern.de/static/gamebroker_2/de/download_files/archiv_lotto.zip">
        <button type="button" id="loadLatestBtn" class="btn btn--green">ğŸ“¥ Neueste laden</button>
        <button type="button" id="forceDlBtn" class="btn btn--amber">â¬‡ï¸ ZIP speichern</button>
        <a id="directDl" class="btn btn--gray" target="_blank" rel="noopener noreferrer">ğŸ”— Direktlink</a>
      </div>
      <p class="text-xs text-gray-300 mt-2">Mehrere CORSâ€‘Proxys als Fallback. Falls alles blockiert wird: ZIP manuell laden und hier ablegen.</p>
    </div>

    <div class="glass mb-3">
      <div class="font-semibold mb-2">Manuell laden</div>
      <label class="file-label">
        ğŸ“„ Datei auswÃ¤hlen
        <input type="file" id="zipInput" class="file-input" accept=".zip,.txt,.csv">
      </label>
      <span id="fileName" class="ml-2 text-sm opacity-80">Keine Datei ausgewÃ¤hlt</span>
      <div class="badge mt-2">Tipp: ZIP/TXT/CSV per Drag & Drop auf die Seite ziehen.</div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
      <div><div class="text-sm text-gray-300">Ziehungen</div><div id="kpiCount" class="font-bold">â€“</div></div>
      <div><div class="text-sm text-gray-300">Von</div><div id="kpiFrom" class="font-bold">â€“</div></div>
      <div><div class="text-sm text-gray-300">Bis</div><div id="kpiTo" class="font-bold">â€“</div></div>
      <div><div class="text-sm text-gray-300">AktualitÃ¤t</div><div id="kpiFresh" class="font-bold">â€“</div></div>
    </div>
    <p id="freshHint" class="text-xs opacity-80 mt-2"></p>
  </div>

  <!-- GENERIEREN -->
  <div id="v-gen" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">âš¡ Generieren</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-gray-300">Anzahl Kombinationen</label>
        <input type="number" id="kombis" value="5" min="1" max="25" class="bg-gray-900 p-2 rounded w-full">
      </div>
      <div class="grid grid-cols-3 gap-2">
        <button type="button" id="generateBtn" class="btn btn--green">âš¡ Generieren</button>
        <button type="button" id="analyseAllBtn" class="btn btn--amber">ğŸ“Š Alle analysieren</button>
        <button type="button" id="clearGeneratedBtn" class="btn btn--gray">ğŸ—‘ï¸ Alle lÃ¶schen</button>
      </div>
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center gap-2">
          <input id="useSuper" type="checkbox" checked><span class="text-sm">Superzahl berÃ¼cksichtigen</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input id="superManual" type="checkbox"><span class="text-sm">Superzahl-Gruppen vorgeben</span>
        </label>
      </div>
    </div>

    <div id="groupUI" class="mt-4">
      <div class="mb-1 text-sm text-gray-300 flex items-center gap-3">
        <span>Gruppen: exakt 6 erforderlich</span>
        <span id="mainCounter" class="counter red">0/6</span>
        <span id="superCounter" class="counter green">1/1</span>
      </div>
      <div id="groupControls" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
      <div id="superControls" class="grid grid-cols-2 gap-2 mt-2 hidden"></div>
      <div id="groupError" class="bg-red-900/40 border border-red-400 text-red-200 rounded px-2 py-1 hidden mt-2"></div>
    </div>

    <pre id="liveOutput" class="font-mono bg-black/70 p-3 mt-3 rounded h-44 overflow-auto text-green-300"></pre>
    <div id="cards" class="mt-3"></div>
  </div>

  <!-- ANALYSE -->
  <div id="v-ana" class="glass hidden">
    <h2 class="text-xl font-bold mb-2">ğŸ“Š Analyse</h2>
    <div id="analysisBox" class="mt-1 text-sm"></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function tab(name, btn){
  ['archiv','gen','ana'].forEach(n=>$('#v-'+n).classList.add('hidden'));
  $('#v-'+name).classList.remove('hidden');
  $$('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
}

/* ======= State ======= */
let draws=[]; // {date, main[6], super:number|null}
let freqMain=Array(50).fill(0); // 1..49
let freqSuper=Array(10).fill(0); // 0..9
let generated=[];

const ARCH_KEY='lz_archive_v1';
const LATEST_REF_KEY='lz_latest_ref_date_v1';
let latestRefDate = localStorage.getItem(LATEST_REF_KEY) || null;

/* ======= KPIs ======= */
function computeFreshnessLabel(endIso){
  if(latestRefDate){
    const end=new Date(endIso), ref=new Date(latestRefDate);
    if(end<ref){
      const days=Math.round((ref-end)/86400000);
      return `veraltet (âˆ’${days} Tage ggÃ¼. neuestem: ${latestRefDate})`;
    }
  }
  const last=new Date(endIso);
  const days=Math.max(0, Math.round((Date.now()-last.getTime())/86400000));
  if(days<=14) return 'aktuell';
  if(days<=60) return `ok (${days} Tage alt)`;
  return `veraltet (${days} Tage alt)`;
}
function setKPIs(){
  if(!draws.length){ $('#kpiCount').textContent='â€“'; $('#kpiFrom').textContent='â€“'; $('#kpiTo').textContent='â€“'; $('#kpiFresh').textContent='â€“'; $('#freshHint').textContent=''; return; }
  $('#kpiCount').textContent=draws.length;
  $('#kpiFrom').textContent=draws[0].date;
  $('#kpiTo').textContent=draws.at(-1).date;
  const label=computeFreshnessLabel(draws.at(-1).date);
  $('#kpiFresh').textContent=label;
  $('#freshHint').textContent = latestRefDate ? `Neuestes Referenz-Ende: ${latestRefDate}` : '';
}

/* ======= Download/Entpacken ======= */
async function fetchZipArrayBuffer(url){
  const trials=[
    url,
    'https://cors.isomorphic-git.org/'+url,
    'https://api.allorigins.win/raw?url='+encodeURIComponent(url),
    'https://thingproxy.freeboard.io/fetch/'+url,
    'https://corsproxy.io/?'+encodeURIComponent(url),
    'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(url),
    'https://yacdn.org/proxy/'+url.replace(/^https?:\/\//,'')
  ];
  let last=null;
  for(const u of trials){
    try{
      const res=await fetch(u, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      // FÃ¼r ZIP immer ArrayBuffer lesen â€“ auch wenn Content-Type fehlt
      const buf=await res.arrayBuffer();
      return buf;
    }catch(e){ last=e; }
  }
  throw last||new Error('Download fehlgeschlagen');
}

async function loadZipAndParse(buf){
  const zip=await JSZip.loadAsync(buf);
  const entries=Object.values(zip.files);
  // mÃ¶gliche Dateinamen: archiv_lotto.csv, lotto_6aus49.txt etc.
  let entry=entries.find(f=>/\.(txt|csv)$/i.test(f.name) && /(lotto|6aus49)/i.test(f.name)) || entries.find(f=>/\.(txt|csv)$/i.test(f.name));
  if(!entry) throw new Error('ZIP ohne TXT/CSV.');
  const text=await entry.async('string');
  parseArchiveText(text,'latest');
}

/* ======= Parser ======= */
function parseArchiveText(txt, source='manual'){
  try{
    txt=txt.replace(/^\uFEFF/,'');
    const lines = txt.replace(/\r\n?/g,'\n').split('\n').map(l=>l.trim()).filter(Boolean);
    const cleaned = lines.filter(l => (l.match(/\d+/g)||[]).length >= 6); // mind. 6 Zahlen
    function iso(y,m,d){ const dt=new Date(+y, +m-1, +d); return isNaN(dt)? null : dt.toISOString().slice(0,10); }
    const regDMY=/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/, regYMD=/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/;
    function parseLine(line){
      const t=line.split(/;|,|\t|\s+/).filter(Boolean); let date=null,rest=[];
      if(t.length&&regDMY.test(t[0])){const m=t[0].match(regDMY); date=iso(m[3],m[2],m[1]); rest=t.slice(1);}
      else if(t.length&&regYMD.test(t[0])){const m=t[0].match(regYMD); date=iso(m[1],m[2],m[3]); rest=t.slice(1);}
      else{rest=t.slice(0);}
      const nums=rest.map(Number).filter(n=>!Number.isNaN(n));
      if(!date){ const only=(line.match(/\d+/g)||[]).map(Number); if(only.length>=6){ const [a,b,c]=only.slice(0,3); const d=iso(c,b,a); if(d) date=d; } }
      const main = nums.filter(n=>n>=1&&n<=49).slice(0,6).sort((a,b)=>a-b);
      // Superzahl 0-9 (wenn vorhanden, meist am Ende)
      let superZ = null;
      const supCand = nums.findLast ? nums.findLast(n=>n>=0 && n<=9) : nums.reverse().find(n=>n>=0 && n<=9);
      if(supCand!==undefined) superZ = supCand;
      if(!date||main.length!==6) return null;
      return {date, main, super: (superZ===null? null : superZ)};
    }
    draws=[]; freqMain.fill(0); freqSuper.fill(0);
    cleaned.forEach(l=>{ const r=parseLine(l); if(r) draws.push(r); });
    if(!draws.length) throw new Error('Keine gÃ¼ltigen Ziehungen erkannt.');
    draws.sort((a,b)=>a.date.localeCompare(b.date));
    draws.forEach(d=>{ d.main.forEach(n=>freqMain[n]++); if(d.super!=null) freqSuper[d.super]++; });
    localStorage.setItem(ARCH_KEY, txt);
    if(source==='latest'){ latestRefDate = draws.at(-1).date; localStorage.setItem(LATEST_REF_KEY, latestRefDate); }
    $('#statusText').textContent='Archiv geladen âœ”';
    setKPIs();
  }catch(e){ $('#statusText').textContent='Fehler: '+e.message; }
}

/* ======= Archiv Buttons ======= */
function updateDirectLink(){ const u=$('#archiveUrl').value.trim(); const a=$('#directDl'); a.href=u; }
updateDirectLink();
$('#archiveUrl').addEventListener('input', updateDirectLink);

document.getElementById('directDl').addEventListener('click', (e)=>{
  e.preventDefault();
  const url=$('#archiveUrl').value.trim();
  // explizit neues Tab Ã¶ffnen (manche Browser ignorieren href bei file:// UrsprÃ¼ngen)
  window.open(url, '_blank', 'noopener');
});

document.getElementById('loadLatestBtn').addEventListener('click', async ()=>{
  const url=$('#archiveUrl').value.trim();
  $('#statusText').textContent='Lade neuestes Archivâ€¦';
  try{
    const buf=await fetchZipArrayBuffer(url);
    await loadZipAndParse(buf);
  }catch(e){
    $('#statusText').textContent='Download nicht mÃ¶glich: '+(e?.message||e);
  }
});
document.getElementById('forceDlBtn').addEventListener('click', async ()=>{
  const url=$('#archiveUrl').value.trim();
  $('#statusText').textContent='Lade ZIPâ€¦';
  try{
    const buf=await fetchZipArrayBuffer(url);
    const blob=new Blob([buf],{type:'application/zip'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='archiv_lotto.zip'; a.click(); URL.revokeObjectURL(a.href);
    $('#statusText').textContent='ZIP gespeichert.';
  }catch(e){
    $('#statusText').textContent='Direkt-Download nicht mÃ¶glich: '+(e?.message||e);
  }
});

document.getElementById('zipInput').addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return; $('#fileName').textContent=file.name;
  try{
    let text='';
    if(file.name.toLowerCase().endsWith('.zip')){
      const buf=await file.arrayBuffer();
      await loadZipAndParse(buf);
      return;
    }else{ text=await file.text(); }
    parseArchiveText(text,'manual');
  }catch(err){ $('#statusText').textContent='Fehler: '+err.message; }
});
document.body.addEventListener('dragover', e=>{ e.preventDefault(); });
document.body.addEventListener('drop', async e=>{
  e.preventDefault();
  const file=e.dataTransfer?.files?.[0]; if(!file) return;
  $('#fileName').textContent=file.name;
  try{
    if(file.name.toLowerCase().endsWith('.zip')){
      const buf=await file.arrayBuffer();
      await loadZipAndParse(buf);
    }else{
      const text=await file.text();
      parseArchiveText(text,'manual');
    }
  }catch(err){ $('#statusText').textContent='Fehler: '+err.message; }
});

/* ======= Gruppen-UI ======= */
const GROUPS=[
  {label:'1â€“10',from:1,to:10},
  {label:'11â€“20',from:11,to:20},
  {label:'21â€“30',from:21,to:30},
  {label:'31â€“40',from:31,to:40},
  {label:'41â€“49',from:41,to:49}
];
const SGROUPS=[
  {label:'0â€“4',from:0,to:4},
  {label:'5â€“9',from:5,to:9}
];
function buildGroupUI(){
  const host=$('#groupControls'); host.innerHTML='';
  GROUPS.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='grid grid-cols-3 gap-2 items-center';
    row.innerHTML = \`<div class="font-bold">\${g.label}</div>
      <select class="bg-gray-900 p-2 rounded" data-idx="\${i}">\${[0,1,2,3,4,5,6].map(v=>\`<option value="\${v}">\${v}</option>\`).join('')}</select>
      <div class="text-right text-sm text-gray-400">0</div>\`;
    host.appendChild(row);
  });
  $$('#groupControls select').forEach(sel=> sel.addEventListener('change', updateGroupCounters));
  updateGroupCounters();
}
function buildSuperUI(){
  const host=$('#superControls'); host.innerHTML='';
  SGROUPS.forEach((g,i)=>{
    const row=document.createElement('div'); row.className='grid grid-cols-3 gap-2 items-center';
    row.innerHTML = \`<div class="font-bold">\${g.label}</div>
      <select class="bg-gray-900 p-2 rounded super" data-idx="\${i}">\${[0,1].map(v=>\`<option value="\${v}">\${v}</option>\`).join('')}</select>
      <div class="text-right text-sm text-gray-400">0</div>\`;
    host.appendChild(row);
  });
  $$('#superControls select').forEach(sel=> sel.addEventListener('change', updateGroupCounters));
}
function setCounter(el, val, total){
  el.textContent = \`\${val}/\${total}\`;
  el.classList.toggle('green', val===total);
  el.classList.toggle('red', val!==total);
}
function updateGroupCounters(){
  let sumG=0; $$('#groupControls select').forEach(s=>{ const v=+s.value||0; sumG+=v; s.parentElement.lastChild.textContent=v; });
  setCounter($('#mainCounter'), sumG, 6);
  let sumS = $('#useSuper').checked && $('#superManual').checked ?
    $$('#superControls select').reduce((a,s)=>a+(+s.value||0),0) : 1; // Auto -> 1 ok
  setCounter($('#superCounter'), sumS, 1);
  const err=$('#groupError'); err.classList.add('hidden'); err.textContent='';
  if(sumG!==6){ err.classList.remove('hidden'); err.textContent='Bitte genau 6 aus den Gruppen wÃ¤hlen.'; }
  if($('#useSuper').checked && $('#superManual').checked && sumS!==1){ err.classList.remove('hidden'); err.textContent='Superzahl-Summe muss 1 sein.'; }
}
buildGroupUI(); buildSuperUI();
$('#useSuper').addEventListener('change', updateGroupCounters);
$('#superManual').addEventListener('change', e=>{ $('#superControls').classList.toggle('hidden', !e.target.checked); updateGroupCounters(); });

/* ======= Helpers ======= */
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pickFromRange(from,to,avoid,count,weightFn){
  const bag=[]; for(let n=from;n<=to;n++){ if(!avoid.includes(n)){ const w=Math.max(1, weightFn?weightFn(n):1); for(let k=0;k<w;k++) bag.push(n);} }
  shuffle(bag);
  const res=[]; for(const v of bag){ if(!res.includes(v)){ res.push(v); if(res.length===count) break; } }
  return res;
}
function superAuto(){
  const fs=[...freqSuper]; const m=Math.max(...fs)||1;
  const w = s=> 1 + Math.round(3*(fs[s]/m));
  const r = pickFromRange(0,9,[],1,w);
  return r.length? r[0] : Math.floor(Math.random()*10);
}

/* ======= Generator (nur Gruppenmodus) ======= */
function generateOne(){
  if(!draws.length){
    const main = pickFromRange(1,49,[],6).sort((a,b)=>a-b);
    const s = $('#useSuper').checked ? superAuto() : null;
    return {main, super:s};
  }
  const want = $$('#groupControls select').map(s=>+s.value||0);
  const sumWant = want.reduce((a,b)=>a+b,0);
  const err=$('#groupError'); err.classList.add('hidden'); err.textContent='';
  if(sumWant!==6){ err.classList.remove('hidden'); err.textContent='Bitte genau 6 aus den Gruppen wÃ¤hlen.'; throw new Error('Gruppen nicht vollstÃ¤ndig.'); }

  const r=draws.slice(-100);
  const fm=Array(50).fill(1); r.forEach(d=>d.main.forEach(n=>fm[n]++));
  const maxM=Math.max(...fm.slice(1));
  const w=n=>Math.ceil(3*fm[n]/maxM);

  let main=[];
  GROUPS.forEach((g,i)=>{ const need=want[i]; if(need>0){ main.push(...pickFromRange(g.from,g.to,main,need,w)); } });
  main = Array.from(new Set(main)).sort((a,b)=>a-b).slice(0,6);

  let s=null;
  if($('#useSuper').checked){
    if($('#superManual').checked){
      const eWant = $$('#superControls select').map(s=>+s.value||0);
      const eSum = eWant.reduce((a,b)=>a+b,0);
      if(eSum!==1){ throw new Error('Superzahl-Summe muss 1 sein.'); }
      let bag=[];
      SGROUPS.forEach((g,i)=>{ if(eWant[i]>0){ for(let n=g.from; n<=g.to; n++){ bag.push(n);} } });
      s = bag.length? bag[Math.floor(Math.random()*bag.length)] : superAuto();
    }else{
      s = superAuto();
    }
  }
  return {main, super:s};
}

/* ======= Typing & Cards ======= */
async function typeLine(el, text){ for(const ch of text){ el.append(ch); await sleep(10);} }
async function printTip(outEl, index, tip){
  await typeLine(outEl, "#"+index+": ");
  for(const n of tip.main){ await typeLine(outEl, n+" "); }
  if(tip.super!=null){ await typeLine(outEl, "| SZ: "+tip.super); }
  outEl.append("\\n"); outEl.scrollTop = outEl.scrollHeight;
}

function analyseVariant(tip){
  let exact=0, hit6=0, hit5=0, hit4=0, hit3=0, exactWithSuper=0;
  for(const d of draws){
    const mMatch = tip.main.filter(x=>d.main.includes(x)).length;
    if(mMatch===6){ hit6++; exact++; if(tip.super!=null && d.super!=null && tip.super===d.super) exactWithSuper++; }
    if(mMatch===5) hit5++;
    if(mMatch===4) hit4++;
    if(mMatch===3) hit3++;
  }
  return {exact, exactWithSuper, hit6, hit5, hit4, hit3};
}

function tipCard(idx, tip){
  const a = analyseVariant(tip);
  const card=document.createElement('div'); card.className='glass mb-3';
  card.innerHTML = \`
    <div class="flex items-center justify-between">
      <div>
        \${tip.main.map(n=>\`<span class="chip">\${n}</span>\`).join('')}
        \${tip.super!=null ? '<span class="badge ml-2">SZ</span><span class="chip super">'+tip.super+'</span>' : ''}
      </div>
      <span class="badge">#\${idx}</span>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mt-2 text-sm">
      <div class="badge">6 Richtige gesamt: <b>\${a.hit6}</b></div>
      <div class="badge">5 Richtige gesamt: <b>\${a.hit5}</b></div>
      <div class="badge">4 Richtige gesamt: <b>\${a.hit4}</b></div>
      <div class="badge">3 Richtige gesamt: <b>\${a.hit3}</b></div>
      <div class="badge">Exakt 6: <b>\${a.exact}</b></div>
      \${tip.super!=null ? '<div class="badge">Exakt 6 + SZ: <b>'+a.exactWithSuper+'</b></div>' : ''}
    </div>
    <div class="mt-2 flex gap-2 flex-wrap">
      <button class="btn btn--gray copy-btn">ğŸ“‹ Kopieren</button>
      <button class="btn btn--gray del-btn">ğŸ—‘ï¸ Entfernen</button>
    </div>\`;
  card.querySelector('.copy-btn').onclick = ()=> navigator.clipboard.writeText(\`\${tip.main.join('-')}\${tip.super!=null? ' | SZ:'+tip.super:''}\`);
  card.querySelector('.del-btn').onclick = ()=>{ card.remove(); generated = generated.filter(g=> g!==tip); };
  return card;
}

/* ====== Buttons ====== */
$('#generateBtn').addEventListener('click', async ()=>{
  if(!draws.length){ alert('Bitte zuerst ein Archiv laden.'); return; }
  const total = +$('#kombis').value || 1;
  const out = $('#liveOutput'); out.textContent='';
  $('#cards').innerHTML='';
  generated=[];
  const seen=new Set();
  for(let i=1;i<=total;i++){
    try{
      let tip = generateOne();
      let key = tip.main.join('-')+'|'+(tip.super ?? 'x');
      let guard=0; while(seen.has(key) && guard<10){ tip = generateOne(); key=tip.main.join('-')+'|'+(tip.super ?? 'x'); guard++; }
      seen.add(key); generated.push(tip);
      await printTip(out, i, tip);
      $('#cards').appendChild(tipCard(i, tip));
    }catch(e){
      const err=$('#groupError'); err.classList.remove('hidden'); err.textContent=e.message; break;
    }
  }
});
$('#clearGeneratedBtn').addEventListener('click', ()=>{ generated=[]; $('#cards').innerHTML=''; $('#liveOutput').textContent=''; });

$('#analyseAllBtn').addEventListener('click', ()=>{
  if(!generated.length){ alert('Bitte zuerst Varianten generieren.'); return; }
  let html = '<div class="glass mt-2"><div class="font-bold mb-2">Auswertung der generierten Kombinationen</div>';
  html += '<div class="overflow-auto"><table class="text-sm min-w-full"><thead><tr>';
  html += '<th class="px-2 py-1 text-left">#</th><th class="px-2 py-1 text-left">Kombi</th><th class="px-2 py-1">6R</th><th class="px-2 py-1">5R</th><th class="px-2 py-1">4R</th><th class="px-2 py-1">3R</th><th class="px-2 py-1">Exakt6</th><th class="px-2 py-1">Exakt6+SZ</th>';
  html += '</tr></thead><tbody>';
  generated.forEach((t,i)=>{
    const a=analyseVariant(t);
    const label = t.main.join(' ') + (t.super!=null? ' | SZ:'+t.super:'');
    html += \`<tr class="border-t border-white/10">
      <td class="px-2 py-1">\${i+1}</td>
      <td class="px-2 py-1">\${label}</td>
      <td class="px-2 py-1 text-center">\${a.hit6}</td>
      <td class="px-2 py-1 text-center">\${a.hit5}</td>
      <td class="px-2 py-1 text-center">\${a.hit4}</td>
      <td class="px-2 py-1 text-center">\${a.hit3}</td>
      <td class="px-2 py-1 text-center">\${a.exact}</td>
      <td class="px-2 py-1 text-center">\${t.super!=null? a.exactWithSuper : 'â€“'}</td>
    </tr>\`;
  });
  html += '</tbody></table></div></div>';
  $('#analysisBox').innerHTML = html;
  tab('ana', $('#btn-ana'));
});

/* ====== Restore ====== */
(()=>{
  const saved=localStorage.getItem(ARCH_KEY);
  if(saved){ try{ parseArchiveText(saved,'manual'); $('#statusText').textContent='Archiv aus Speicher geladen âœ”'; }catch{} }
  latestRefDate = localStorage.getItem(LATEST_REF_KEY) || latestRefDate;
  setKPIs();
})();
</script>
</body>
</html>
